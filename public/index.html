<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAC+lBMVEUAAADMeCTOZxXlrS7KYhPIYBPFXhTFYRbDXxnTiynFZB/RbxjMZRTfnSjWjybfmCbViiLksC/Xfx/MZRXenijWgyDSdRvJYhTJZRbGXhTfpSrUgB/NbhnbmyfQfB7VjibCXBjRgyPCXBfBWxfZhCHUeR3hoirclibakyTirC3hqy3doSrcoCnViCLUhSHGXxTGXhTXjSPViiLZnCjZmyfXlinWlSjTiSUxMTAsLSomJyMaHBVTVFL899v23Djjhx+EhINQUE7wqyr778H0uzDupynnkiPmjyL++ef89dD88sT88rn88a766azysy7xsSvplyTljSGHh4b0uS/pmSfqmyUgIyDggR399M/877jLvIXroi/ytS7toyrtpCjsoScaHRvbeRr20jbvvTbrnyvrnibjiiHZdhrWchgVFxj89NL888X67Lf87q3776P56aDRvYRbXF333T330zj11zb30DXzwTXtuTPNlzLvqi7qmifnlCVlVyEkJB/ihB7dfh399tn66rb20GFeX2BZWlv21jbttTPYgR4cIR378c366LD77K355Kj67aL44Z/z5p3p25f06ZTr4I/VyIv21oX53HX20WmgmWb311ro1lnJu1b31FL0xVLptVLhsFL20E3ttExSUkv34En1y0ju2Ubkr0ZgXkb1z0XvsENAQkN7dT/xyz7usT3wtzzu1jvzyTuCazrz2TnYpznqtjjXrDi7qzjt0Dfvxjf2zDbmsTbtqDb0xDXnxjTjvzPjuzLnujLtsDK8gzKvdzJpYzHcqTCydzDlsi/apS+0gy+0ey+DaC/wri7pqS47Oy3lnSujkitIQCvwriqyjiqwfyguLickJSZvViWbXCSaWyR9ZyMgJiJCPyA1MyDdgB5NPR777br656j53oX43X9/f37302/z4FTz31TTrFPTqU7MoEnKn0jInkjPvkfNvEfOoEbVvzTUvjTdnyzcniynayymayzalCfZkiZxXCZwXCZ1aCN0ZyOMVCGKVCDWfR4NhNEoAAAAOHRSTlMADP777tmUYSsTE/r67ir8+fLy8tnT09KlpaKiopRhODgsKiry8u7Z2dPTpaWlpaKilJRhYSwsKgybqxsAAAMcSURBVDjLYkAATmMpTcFjxwS1pEw4GTCBqTZz8vrls2fMmL18fTKzjhmaNKMsc9n8qfnOWQ0NWc75U+eXMcsyIsvziZQvfuhs6wEFDfcfLW4T4UPIy6slN/lm2SKBrAdNybzycP28yU8aOyMiIjyhAMjs7JpWzmsOtV+9bVqXs7OzFxBkAwGIBnJ9m9o0IO4wPDOnrzEnJzIy0hsKgMycnMa+OWeMQPIAKfKvndLj6+vbnZvrAwW5ud1AgZ4pa/kVgQp0Pz4vKIiKipo8oT+/Nw8IevP7J0wGChQUvPikBww/gXuZKwubm5sLbRYumz5p4sRJ05cttGkpLGxpWZl5T4CTQe7rtQQHKHhsc+Xs2Ss2DkEQ4JBw7Zscg/S5l1aOcGCRmWlhAwdW785JM4hGz7tgCQdhq1aFIXgX5kWLMqhEz91w1QIGamfNqoVzrm6YGy3E0B694HWtFRSEHZ4583AYjFf7akF0O6BsOndpGIoDOP4ovWg7KXiAgyjOugs+CHnJliYkbZYmaUIuV2u1F+1U7N8hCoIieN8nitcg6qD2GHVSFBS8wYctheJn/X3ht/x+YEyfmjwd7K8qP9zdP5b7a04np/Qf0CSsz8y/RwvFYjhaWpoYH59YKkUL4XAh+jY/sy70gJa0ntw9uLzNZD7On2aHsNnn889M5vbyYDepUy2gw0xJZ5HRne2tzeW5gT9zy5tb2zujkTNJMDuAp5LWEcOPbKzGY/lqkI/FVzdGeAYZ6ZwH+PycICUZ8uhqJa5pw1hei69cHZFMUmFNvw+AtgqdkgiGTHwdL07HNC02vXj8nSAZQhLoXBsAwOuHVErGxdrJzfXr/v7L9c3JGo/nKSrr8ALMbUEqJBPBCLmQ2Ds83EsskJEgoYQoaLurJ+dSIS0oCCc8T5I8j8fIYGlouWqn3+XEBWvIiLgIYhcEUkIsB1VnN6jpdKpZjmINRUYIybJisBSXtZydoK7LZYsQJ0IIY9MUB0Xb1d3wem6HJUKTozHOhKIVcOP9DbztAVvNiVlRzKl2oN0L/vN5elubHY7m1j6PD9T9AieDT/vUiS5zAAAAAElFTkSuQmCC"/>
  <!--  <script src="https://unpkg.com/canvg@4.0.1/dist/index.cjs" crossorigin></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.9/umd.js" crossorigin></script>
  <!-- Load our React component. -->
  <script src="index.js"></script>
  <style>
      body {
          display: flex;
          flex-direction: column;
          row-gap: 20px;
      }

      button {
          width: 200px;
      }

      textarea {
          width: 200px;
          height: 100px;
      }

      #original_svg_placeholder, #result_svg_placeholder {
          display: none;
      }

      #images {
          display: none;
          flex-direction: row;
          justify-content: center;
          column-gap: 10px;
          padding: 10px;
      }

      #original_image_placeholder, #result_image_placeholder {
          /*width: calc(50% - 10px);*/
          width: 100%;
          border: 3px solid black;
      }

      #result_save_SVG_button, #result_save_PNG_button {
          display: none;
      }

      .picture_with_description {
          display: flex;
          flex-direction: column;
      }

      .picture_description {
          text-align: center;
          font-weight: bolder;
          font-size: 20px;
      }

      #lol {
          display: none;
      }
  </style>
  <title>Trim UML</title>
</head>

<body>

  <p>Экспорируйте диаграмму из StarUML как SVG файл. Выберите созданный .SVG файл</p>
  <input type="file" id="fileToLoad">

  <div id="original_svg_placeholder"></div>
  <div id="result_svg_placeholder"></div>

  <button id="result_save_SVG_button" onclick="save('SVG')">Сохранить SVG без водяного знака</button>
  <button id="result_save_PNG_button" onclick="save('PNG')">Сохранить PNG без водяного знака</button>
  <a id="lol">Сохранить PNG без водяного знака</a>

  <div id="images">
    <div class="picture_with_description">
      <p class="picture_description">С водяным знаком</p>
      <img id="original_image_placeholder"/>
    </div>
    <div class="picture_with_description">
      <p class="picture_description">Без водяного знака</p>
      <img id="result_image_placeholder"/>
    </div>
  </div>

  <a href="https://github.com/Alex-1701/trim_UML" target="_blank">GitHub</a>

  <script>
    let originalString = null;
    let resultStringSVG = null;

    const fileToLoad = document.getElementById("fileToLoad");

    fileToLoad.addEventListener("change", () => {
      loadFileAsText();
    })

    function loadFileAsText() {
      const fileToLoad = document.getElementById("fileToLoad").files[0];

      const fileReader = new FileReader();

      fileReader.onload = function (fileLoadedEvent) {
        originalString = fileLoadedEvent.target.result;
        const regex = /<\s*text[^>]*>UNREGISTERED<\s*\/\s*text>/gm;
        const subst = ``;
        resultStringSVG = originalString.replace(regex, subst);
        drawInSVG()
        convertToPNG()
      };

      fileReader.readAsText(fileToLoad, "UTF-8");
    }

    function drawInSVG() {
      document.getElementById("original_svg_placeholder").innerHTML = originalString;
      document.getElementById("result_svg_placeholder").innerHTML = resultStringSVG;
      drawInImg();
    }

    function drawInImg() {
      const original_svg_box = document.getElementById("original_svg_placeholder");
      const original_svgElement = original_svg_box.children[0];
      const original_imgElement = document.getElementById("original_image_placeholder");
      const original_xml = (new XMLSerializer()).serializeToString(original_svgElement);
      original_imgElement.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(original_xml)));

      const result_svg_box = document.getElementById("result_svg_placeholder");
      const result_svgElement = result_svg_box.children[0];
      const result_imgElement = document.getElementById("result_image_placeholder");
      const result_xml = (new XMLSerializer()).serializeToString(result_svgElement);
      result_imgElement.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(result_xml)));

      document.getElementById("result_save_SVG_button").style.display = "block";
      document.getElementById("result_save_PNG_button").style.display = "block";
      document.getElementById("images").style.display = "flex";
    }


    const save = (option) => {
      if (option === "SVG") {
        if ('showSaveFilePicker' in window) {
          return downloadAs(resultStringSVG);
        }
        return download(resultStringSVG);
      } else if (option === "PNG") {

        document.getElementById("lol").click();

      }
    };



    function download(text) {
      const file = new File([text], 'name.svg', {
        type: 'image/svg+xml',
      })

      const link = document.createElement('a')
      const url = URL.createObjectURL(file)

      link.href = url
      link.download = file.name
      document.body.appendChild(link)
      link.click()

      document.body.removeChild(link)
      window.URL.revokeObjectURL(url)
    }

    async function downloadAs(text) {
      const handle = await window.showSaveFilePicker({
        suggestedName: 'name.svg',
        types: [{
          description: 'Text file',
          accept: {'image/svg+xml': ['.svg']},
        }],
      });

      const blob = new Blob([text]);

      const writableStream = await handle.createWritable();
      await writableStream.write(blob);
      await writableStream.close();
    }
  </script>
</body>
</html>
